# Maintainer: Rexct <rexct1 at gmail dot com>
pkgname=php
pkgver=5.5.1
pkgrel=1
pkgdesc="An HTML-embedded scripting language"
arch=('sh4')
url="http://www.php.net"
license=('PHP')
backup=('usr/local/php/php.ini')
groups=()
depends=('libxml2' 'libmcrypt')
optdepends=('mysql-devel')
makedepends=( 'autoconf>=2.59' 'libtool>=1.4' 'bison' 
             'apache' 'xz' 'libpng' 'libjpeg-turbo' 
             'openssl' 'curl' 'openssl' 'db' )
provides=()
conflicts=('php')
options=()
changelog=$pkgname.changelog
source=($pkgname-$pkgver.tar.xz::http://tw1.php.net/distributions/${pkgname}-${pkgver}.tar.xz 
        filters.patch
        httpd.conf)
noextract=()
md5sums=('010db7290ac850623584050b9e34b2ee'
         'bb589d945c60e962c84a7ae3a1fecae8'
         '3310173808a5f55297b0605e133ec441')

build() {
  patch -Np1 -i "${srcdir}/filters.patch"
  cd "${srcdir}/${pkgname}-${pkgver}"
  ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php \
  --with-apxs2=/usr/local/apache/bin/apxs --with-zlib-dir=/usr/lib \
  --with-mcrypt=/usr/local/libmcrypt --with-libxml-dir=/usr/local/libxml2 \
  --with-mysql-dir=/usr/include/mysql/mysql.h --with-mysql=/usr/local/mysql/ \
  --with-mysqli=/usr/local/mysql/bin/mysql_config \
  --with-mysql-sock=/tmp/mysql.sock \
  --with-gd  --with-jpeg --with-png --with-xpm --with-iconv --with-freetype \
  --with-zlib --with-libxml --enable-xml --enable-discard-path \
  --enable-magic-quotes --enable-safe-mode --enable-bcmath --enable-shmop \
  --enable-sysvsem --enable-inline-optimization --with-curlwrappers \
  --enable-mbregex --enable-fastcgi --enable-force-cgi-redirect \
  --enable-mbstring --enable-ftp --enable-gd-native-ttf --with-openssl \
  --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap \
  --without-pear --with-gettext --with-mime-magic --enable-suhosin \
  --enable-session --with-mcrypt 
}

check() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  make -j1 check
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  
  mkdir -p "${pkgdir}"/etc/httpd
  cp --no-preserve=ownership "${srcdir}"/httpd.conf "${pkgdir}"/etc/httpd/httpd.conf
  ln -fs "${srcdir}/${pkgname}-${pkgver}"/ext/phar/phar.php "${srcdir}/${pkgname}-${pkgver}"/ext/phar/phar.phar
  
  make INSTALL_ROOT="${pkgdir}" install
  
  mkdir -p "${pkgdir}"/usr/local/php
  if [[ ! -f $pkgdir'/usr/local/php/php.ini' ]];then
    cp --no-preserve=ownership "${srcdir}"/"${pkgname}"-"${pkgver}"/php.ini-production  "${pkgdir}"/usr/local/php/php.ini
  fi
  mv "${pkgdir}"/etc/httpd/httpd.conf "${pkgdir}"/etc/httpd/httpd.conf.php.default
}
